<html>
  <head>
    <title>
      Spectacled Porpoise
    </title>
    <link rel="icon" 
          type="image/png" 
          href="img/wave.png">
  </head>
  <body style="background: black">
  <div id="my-gui-container" style="position: fixed; right: 0;"></div>
  </body>

<script id="velocity-vs" type="x-shader/x-vertex">
  precision mediump float;
  precision mediump int;

  attribute vec2 aVertexCoord;

  uniform float uGridSize;
  uniform vec2 uViewportSize;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  void main(void) {
    gl_Position = vec4(aVertexCoord, 0.0, 1.0);
  }
</script>

<script id="velocity-fs" type="x-shader/x-fragment">
  #line 0 111
  precision mediump float;
  precision mediump int;

  uniform sampler2D uParticlePositionData;
  uniform sampler2D uParticleVelocityData;
  uniform vec2 uViewportSize;
  uniform float uGridSize;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  vec4 getPosition() {
    return texture2D(uParticlePositionData, gl_FragCoord.xy/uViewportSize);
  }

  vec4 getVelocity() {
    return texture2D(uParticleVelocityData, gl_FragCoord.xy/uViewportSize);
  }

  void main(void) {
    vec3 vel = getVelocity().xyz;
    gl_FragColor = vec4(vel, 1.0) + 0.01*vec4(0.0, -9.8, 0.0, 1.0);
  }
</script>

<script id="physics-vs" type="x-shader/x-vertex">
  precision mediump float;
  precision mediump int;

  attribute vec2 aVertexCoord;

  uniform float uGridSize;
  uniform vec2 uViewportSize;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  void main(void) {
    gl_Position = vec4(aVertexCoord, 0.0, 1.0);
  }
</script>

<script id="physics-fs" type="x-shader/x-fragment">
  #line 0 100
  precision mediump float;
  precision mediump int;

  uniform sampler2D uParticlePositionData;
  uniform sampler2D uParticleVelocityData;
  uniform vec2 uViewportSize;
  uniform float uGridSize;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  vec4 getPosition() {
    return texture2D(uParticlePositionData, gl_FragCoord.xy/uViewportSize);
  }

  vec4 getVelocity() {
    return texture2D(uParticleVelocityData, gl_FragCoord.xy/uViewportSize);
  }

  void main(void) {
    vec3 pos = getPosition().xyz;
    vec3 dir = getVelocity().xyz;
    gl_FragColor = vec4(pos, 1.0) + 0.01*vec4(dir, 1.0);
  }
</script>

<script id="render-vs" type="x-shader/x-vertex">
  precision mediump float;
  precision mediump int;

  attribute float aParticleIndex;

  uniform float uGridSize;

  uniform sampler2D uParticlePositionData;
  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  varying float vCoord;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }


  void main(void) {
  #line 10 100
    vec2 uv = getUVFromIndex(aParticleIndex);
    vec4 particle = texture2D(uParticlePositionData, uv);
    vCoord = aParticleIndex;
    gl_Position = uPMatrix * uMVMatrix * particle;
    gl_PointSize = 3.0;
  }
</script>

<script id="render-fs" type="x-shader/x-fragment">

  #line 0 10
  precision mediump float;

  uniform sampler2D uParticlePositionData;
  uniform float uGridSize;

  varying float vCoord;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  void main(void) {
    gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);//texture2D(uParticlePositionData, getUVFromIndex(vCoord));
  }
</script>

<script id="ssfr-depth-vs" type="x-shader/x-vertex">
    #line 0 100
  precision mediump float;
  precision mediump int;

  attribute float aParticleIndex;

  uniform float uGridSize;
  uniform float uParticleRadius;
  uniform float uParticleScale;

  uniform sampler2D uParticlePositionData;
  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  varying float vCoord;
  varying vec3 posEye;
  varying float particleDepth;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  void main(void) {
    vec2 uv = getUVFromIndex(aParticleIndex);
    vec4 particle = texture2D(uParticlePositionData, uv);

    //posEye = vec3(uMVMatrix * particle);
    //particleDepth = vec3(uPMatrix * uMVMatrix * particle).z;
    //float dist = length(posEye);
    //gl_PointSize = uParticleRadius * (uParticleScale / dist);
    gl_PointSize = 20.0;
    gl_Position = uPMatrix * uMVMatrix * particle;
  }
</script>

<script id="ssfr-depth-fs" type="x-shader/x-fragment">
  precision mediump float;

  uniform sampler2D uParticlePositionData;

  uniform float uParticleRadius;
  uniform float near;
  uniform float far;

  uniform mat4 uPMatrix;
  varying vec3 posEye;
  varying float particleDepth;

  void main(void) {
  #line 0 10
    vec3 norm;

    norm.xy = (gl_PointCoord.st * vec2(2.0, -2.0)) + vec2(-1.0, 1.0);
    float mag = dot(norm.xy, norm.xy);
    if (mag > 1.0) discard;
    norm.z = sqrt(1.0 - mag);

    //vec4 spherePosEye = vec4(posEye + norm * uParticleRadius, 1.0);
    //vec4 clipSpacePos = uPMatrix * spherePosEye;
    //vec4 clipSpacePos = uPMatrix * vec4(norm, 1.0);
    //float normDepth = clipSpacePos.z/clipSpacePos.w;
    //float normDepth = gl_FragCoord.z;

    //gl_FragDepth = (((far-near)/2.0)*normDepth) + ((far+near)/2.0);
    //float depth = (((far-near)/2.0)*normDepth) + ((far+near)/2.0);
    //gl_FragColor = vec4(depth, depth, depth, 1.0); 
    gl_FragColor = vec4(norm, 1.0);
    //gl_FragColor = vec4(clipSpacePos, clipSpacePos, clipSpacePos, 1.0); 
    //gl_FragColor = vec4(norm.z, norm.z, norm.z, 1.0);
    //gl_FragColor = vec4(particleDepth, particleDepth,particleDepth , 1.0);
    //gl_FragColor = vec4(gl_FragCoord.z, gl_FragCoord.z, gl_FragCoord.z, 1.0);
  }
</script>
<script id="debug-vs" type="x-shader/x-vertex">
  precision mediump float;
  precision mediump int;

  attribute float aParticleIndex;

  uniform float uGridSize;

  uniform sampler2D uParticlePositionData;
  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  varying float vCoord;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }


  void main(void) {
  //#line 10 100
    vec2 uv = getUVFromIndex(aParticleIndex);
    vec4 particle = texture2D(uParticlePositionData, uv);
    vCoord = aParticleIndex;
    gl_Position = uPMatrix * uMVMatrix * vec4(uv.x, uv.y, 0.0, 1.0);
    gl_PointSize = 10.0;
  }
</script>

<script id="debug-fs" type="x-shader/x-fragment">

  //#line 0 10
  precision mediump float;

  uniform sampler2D uParticlePositionData;
  uniform float uGridSize;

  varying float vCoord;

  vec2 getUVFromIndex(float particleNumber) {
    float interval = 1.0/uGridSize;
    vec2 uv;
    uv.x = interval * (mod(particleNumber, uGridSize) + 0.5);
    uv.y = interval * (floor(particleNumber/uGridSize) + 0.5);
    return uv;
  }

  void main(void) {
    gl_FragColor = texture2D(uParticleData, getUVFromIndex(vCoord));
  }
</script>



<script src="js/gl-matrix-min.js"></script>
<script src="js/lightgl.js"></script>
<script src="js/webgl-utils.js"></script>
<script src="js/webgl-debug.js"></script>
<script src="js/dat.gui.js"></script>
<script src="js/main.js"></script>
</html>
